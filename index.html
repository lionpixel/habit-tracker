<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitDB 2026 â€” Sistema CientÃ­fico de HÃ¡bitos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --cyan: #06b6d4;
            --dark: #0f172a;
            --darker: #020617;
            --card-bg: #1e293b;
            --light: #f8fafc;
            --gray: #94a3b8;
            --border-radius: 16px;
            --transition: all 0.3s ease;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }

        body {
            background: linear-gradient(135deg, var(--darker), #1e1b4b);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container { max-width: 1800px; margin: 0 auto; }

        /* â”€â”€ HEADER â”€â”€ */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(30,41,59,0.7);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent, rgba(99,102,241,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        h1 {
            font-size: 3rem;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .subtitle { color: var(--gray); font-size: 1.1rem; max-width: 900px; margin: 0 auto 10px; position: relative; z-index: 1; }
        .date-display { font-size: 0.95rem; color: var(--info); margin-top: 10px; font-weight: 600; }

        /* â”€â”€ TABS â”€â”€ */
        .view-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background: rgba(15,23,42,0.6);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tab-btn {
            background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(99,102,241,0.1));
            color: white;
            border: 1px solid rgba(99,102,241,0.3);
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .tab-btn:hover { background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(99,102,241,0.2)); transform: scale(1.05); }
        .tab-btn.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-color: var(--primary); box-shadow: 0 5px 15px rgba(99,102,241,0.4); }

        /* â”€â”€ STATS OVERVIEW â”€â”€ */
        .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }

        .stat-card {
            background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(30,41,59,0.7));
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .stat-card.reading::before { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .stat-card.english::before { background: linear-gradient(90deg, #10b981, #059669); }
        .stat-card.hiit::before { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .stat-card.ppci::before { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .stat-card.dopamine::before { background: linear-gradient(90deg, #ec4899, #db2777); }
        .stat-card.fasting::before { background: linear-gradient(90deg, #06b6d4, #0891b2); }

        .stat-icon { font-size: 2.5rem; margin-bottom: 15px; width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 auto 15px; }
        .reading .stat-icon { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .english .stat-icon { background: rgba(16,185,129,0.2); color: #10b981; }
        .hiit .stat-icon { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .ppci .stat-icon { background: rgba(139,92,246,0.2); color: #8b5cf6; }
        .dopamine .stat-icon { background: rgba(236,72,153,0.2); color: #ec4899; }
        .fasting .stat-icon { background: rgba(6,182,212,0.2); color: #06b6d4; }

        .stat-value { font-size: 2.5rem; font-weight: 800; margin: 10px 0; background: linear-gradient(90deg, var(--light), #cbd5e1); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .stat-label { color: var(--gray); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .stat-meta { font-size: 0.85rem; color: var(--gray); margin-top: 10px; }

        /* â”€â”€ SELECTORS â”€â”€ */
        .week-selector, .month-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background: rgba(15,23,42,0.6);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .nav-btn:hover { background: linear-gradient(135deg, var(--primary-dark), var(--accent)); transform: scale(1.05); }
        .nav-btn:disabled { background: rgba(148,163,184,0.3); cursor: not-allowed; transform: none; }
        .period-display { font-size: 1.3rem; font-weight: 700; color: var(--light); min-width: 250px; text-align: center; }

        /* â”€â”€ HABITS GRID â”€â”€ */
        .habits-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px; }

        .habit-card {
            background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(30,41,59,0.7));
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .habit-card:hover { box-shadow: 0 12px 35px rgba(0,0,0,0.4); transform: translateY(-5px); }
        .habit-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; }
        .habit-card.reading::before { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .habit-card.english::before { background: linear-gradient(90deg, #10b981, #059669); }
        .habit-card.hiit::before { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .habit-card.ppci::before { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .habit-card.dopamine::before { background: linear-gradient(90deg, #ec4899, #db2777); }
        .habit-card.fasting::before { background: linear-gradient(90deg, #06b6d4, #0891b2); }

        .habit-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1); }
        .habit-title { display: flex; align-items: center; gap: 12px; }
        .habit-icon { font-size: 2rem; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .reading .habit-icon { background: rgba(59,130,246,0.2); color: #3b82f6; }
        .english .habit-icon { background: rgba(16,185,129,0.2); color: #10b981; }
        .hiit .habit-icon { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .ppci .habit-icon { background: rgba(139,92,246,0.2); color: #8b5cf6; }
        .dopamine .habit-icon { background: rgba(236,72,153,0.2); color: #ec4899; }
        .fasting .habit-icon { background: rgba(6,182,212,0.2); color: #06b6d4; }
        .habit-name { font-size: 1.3rem; font-weight: 700; color: var(--light); }
        .habit-count { font-size: 2rem; font-weight: 800; }
        .reading .habit-count { color: #3b82f6; }
        .english .habit-count { color: #10b981; }
        .hiit .habit-count { color: #f59e0b; }
        .ppci .habit-count { color: #8b5cf6; }
        .dopamine .habit-count { color: #ec4899; }
        .fasting .habit-count { color: #06b6d4; }
        .habit-description { color: var(--gray); font-size: 0.95rem; margin-bottom: 20px; line-height: 1.5; }

        /* â”€â”€ PROGRESS â”€â”€ */
        .habit-progress { margin: 20px 0; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .progress-bar { height: 10px; background: rgba(148,163,184,0.2); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 5px; transition: width 0.3s ease; }
        .reading .progress-fill { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .english .progress-fill { background: linear-gradient(90deg, #10b981, #059669); }
        .hiit .progress-fill { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .ppci .progress-fill { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .dopamine .progress-fill { background: linear-gradient(90deg, #ec4899, #db2777); }
        .fasting .progress-fill { background: linear-gradient(90deg, #06b6d4, #0891b2); }

        /* â”€â”€ STATS ITEMS â”€â”€ */
        .habit-stats { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin: 20px 0; }
        .stat-item { background: rgba(15,23,42,0.6); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.05); transition: var(--transition); }
        .stat-item:hover { border-color: rgba(255,255,255,0.1); background: rgba(15,23,42,0.8); }
        .rotating-comparison:hover { border-color: rgba(99,102,241,0.3); background: rgba(99,102,241,0.05); cursor: help; }
        .stat-item-label { font-size: 0.75rem; color: var(--gray); text-transform: uppercase; margin-bottom: 5px; }
        .stat-item-value { font-size: 1.2rem; font-weight: 700; color: var(--light); }

        /* â”€â”€ BUTTONS â”€â”€ */
        .habit-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .habit-btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-add { background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white; }
        .btn-add:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(16,185,129,0.4); }
        .btn-add:active { transform: scale(0.98); }
        .btn-remove { background: rgba(239,68,68,0.2); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
        .btn-remove:hover { background: rgba(239,68,68,0.3); transform: scale(1.02); }
        .btn-remove:active { transform: scale(0.98); }

        /* â”€â”€ CHARTS â”€â”€ */
        .charts-section { margin: 30px 0; }
        .chart-card { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(30,41,59,0.7)); border-radius: var(--border-radius); padding: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px; }
        .chart-header { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1); }
        .chart-header h2 { font-size: 1.5rem; color: var(--light); }
        .chart-container { position: relative; height: 400px; }

        /* â”€â”€ MONTHLY COMPARISON â”€â”€ */
        .monthly-comparison { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(30,41,59,0.7)); border-radius: var(--border-radius); padding: 35px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); margin: 30px 0; }
        .section-title { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; font-size: 1.8rem; color: var(--light); }
        .month-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap: 20px; margin: 25px 0; }
        .month-card { background: rgba(15,23,42,0.6); padding: 25px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); transition: var(--transition); }
        .month-card:hover { border-color: rgba(255,255,255,0.2); transform: translateY(-5px); }
        .month-name { font-size: 1.3rem; font-weight: 700; color: var(--light); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .month-stats { display: grid; gap: 12px; }
        .month-stat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(99,102,241,0.05); border-radius: 8px; }

        /* â”€â”€ INSIGHTS â”€â”€ */
        .insights-section { display: grid; gap: 20px; margin: 30px 0; }
        .insight-card { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(30,41,59,0.7)); border-radius: var(--border-radius); padding: 25px; border-left: 4px solid; display: flex; gap: 20px; align-items: flex-start; transition: var(--transition); }
        .insight-card:hover { transform: translateX(5px); }
        .insight-card.success { border-left-color: var(--secondary); }
        .insight-card.warning { border-left-color: var(--warning); }
        .insight-card.info { border-left-color: var(--info); }
        .insight-icon { font-size: 2rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; }
        .success .insight-icon { background: rgba(16,185,129,0.2); color: var(--secondary); }
        .warning .insight-icon { background: rgba(245,158,11,0.2); color: var(--warning); }
        .info .insight-icon { background: rgba(14,165,233,0.2); color: var(--info); }
        .insight-content h3 { font-size: 1.2rem; color: var(--light); margin-bottom: 10px; }
        .insight-content p { color: var(--gray); line-height: 1.6; }

        /* â”€â”€ RISK ALERTS â”€â”€ */
        @keyframes pulseAlert { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .risk-alert-critical { animation: pulseAlert 2s ease-in-out infinite; }
        .risk-alert { animation: slideInLeft 0.5s ease; }

        /* â”€â”€ SCIENCE SECTION â”€â”€ */
        .science-toggle-btn { transition: all 0.3s ease; }
        .science-toggle-btn:hover { background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(99,102,241,0.2)) !important; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(139,92,246,0.3); }
        .science-section { max-height: 2000px; overflow-y: auto; }
        .science-section::-webkit-scrollbar { width: 8px; }
        .science-section::-webkit-scrollbar-track { background: rgba(15,23,42,0.3); border-radius: 4px; }
        .science-section::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.5); border-radius: 4px; }
        .science-section::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.7); }

        /* â”€â”€ ROTATING COMPARISON â”€â”€ */
        .rotating-comparison { position: relative; overflow: hidden; }
        .comparison-badge { transition: opacity 0.4s ease, transform 0.4s ease; animation: fadeIn 0.5s ease; font-weight: 600 !important; text-align: center; }
        .comparison-badge.fade-out { opacity: 0; transform: translateY(-5px); }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .rotating-comparison .fa-sync-alt { animation: spin-slow 3s linear infinite; }
        .rotating-comparison:hover .fa-sync-alt { animation: spin-slow 1s linear infinite; }

        /* â”€â”€ ANIMATIONS â”€â”€ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .view-section { display: none; animation: fadeIn 0.5s ease; }
        .view-section.active { display: block; }

        /* â”€â”€ RESPONSIVE â”€â”€ */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .habits-grid { grid-template-columns: 1fr; }
            .stats-overview { grid-template-columns: 1fr; }
            .month-grid { grid-template-columns: 1fr; }
            .view-tabs { flex-direction: column; }
        }

        /* â”€â”€ EXPORT BUTTON â”€â”€ */
        .export-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 14px 22px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 8px 25px rgba(99,102,241,0.5);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }
        .export-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 12px 30px rgba(99,102,241,0.6); }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ¯ HabitDB 2026</h1>
        <div class="subtitle">Sistema CientÃ­fico de FormaÃ§Ã£o de HÃ¡bitos â€¢ Banco de Dados Anual Completo</div>
        <div class="date-display" id="currentDate"></div>
    </header>

    <div class="view-tabs">
        <button class="tab-btn active" onclick="switchView('weekly')" id="weeklyTab">
            <i class="fas fa-calendar-week"></i> VisÃ£o Semanal
        </button>
        <button class="tab-btn" onclick="switchView('monthly')" id="monthlyTab">
            <i class="fas fa-calendar-alt"></i> VisÃ£o Mensal
        </button>
        <button class="tab-btn" onclick="switchView('yearly')" id="yearlyTab">
            <i class="fas fa-chart-line"></i> VisÃ£o Anual 2026
        </button>
    </div>

    <!-- VISÃƒO SEMANAL -->
    <div id="weeklyView" class="view-section active">
        <div class="stats-overview" id="statsOverview"></div>
        <div class="week-selector">
            <button class="nav-btn" onclick="previousWeek()"><i class="fas fa-chevron-left"></i> Anterior</button>
            <div class="period-display" id="weekDisplay"></div>
            <button class="nav-btn" onclick="nextWeek()" id="nextWeekBtn">PrÃ³xima <i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="habits-grid" id="habitsGrid"></div>
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <i class="fas fa-chart-line" style="color:var(--primary);font-size:2rem;"></i>
                    <h2>Progresso Semanal de Todos os HÃ¡bitos</h2>
                </div>
                <div class="chart-container"><canvas id="allHabitsChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <i class="fas fa-calendar-alt" style="color:var(--secondary);font-size:2rem;"></i>
                    <h2>EvoluÃ§Ã£o nas Ãšltimas 8 Semanas</h2>
                </div>
                <div class="chart-container"><canvas id="evolutionChart"></canvas></div>
            </div>
        </div>
        <div id="riskAlertsSection"></div>
        <div class="insights-section" id="insightsSection"></div>
    </div>

    <!-- VISÃƒO MENSAL -->
    <div id="monthlyView" class="view-section">
        <div class="month-selector">
            <button class="nav-btn" onclick="previousMonth()"><i class="fas fa-chevron-left"></i> Anterior</button>
            <div class="period-display" id="monthDisplay"></div>
            <button class="nav-btn" onclick="nextMonth()" id="nextMonthBtn">PrÃ³ximo <i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="stats-overview" id="monthStatsOverview"></div>
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <i class="fas fa-chart-bar" style="color:var(--accent);font-size:2rem;"></i>
                    <h2>Desempenho Mensal por HÃ¡bito</h2>
                </div>
                <div class="chart-container"><canvas id="monthChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- VISÃƒO ANUAL -->
    <div id="yearlyView" class="view-section">
        <div class="stats-overview" id="yearStatsOverview"></div>
        <div class="monthly-comparison">
            <div class="section-title"><i class="fas fa-calendar"></i> ComparaÃ§Ã£o MÃªs a MÃªs 2026</div>
            <div class="month-grid" id="monthlyGrid"></div>
        </div>
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <i class="fas fa-chart-line" style="color:var(--secondary);font-size:2rem;"></i>
                    <h2>EvoluÃ§Ã£o Anual 2026 â€” Todos os HÃ¡bitos</h2>
                </div>
                <div class="chart-container"><canvas id="yearChart"></canvas></div>
            </div>
        </div>
    </div>
</div>

<!-- BOTÃƒO DE EXPORT -->
<button class="export-btn" onclick="exportData()" title="Exportar dados como JSON">
    <i class="fas fa-download"></i> Exportar Dados
</button>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HABITDB 2026 â€” Core Application
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORAGE_KEY = 'habitSciencePro2026Complete';

let appData = {
    currentWeek: null,
    currentYear: 2026,
    currentMonth: null,
    habits: {
        reading: {
            name: 'ğŸ“š Leitura', icon: 'fa-book', color: '#3b82f6',
            target: 25, unit: 'minutos', frequency: 5,
            counts: {}, description: '25 minutos de leitura, 5 dias por semana',
            totalYear: 0, monthlyTotals: {}
        },
        english: {
            name: 'ğŸ—£ï¸ InglÃªs', icon: 'fa-language', color: '#10b981',
            target: 50, unit: 'minutos', frequency: 6,
            counts: {}, seriesCounts: {},
            description: '50 minutos de estudo, 6 dias por semana',
            totalYear: 0, monthlyTotals: {}, carryoverMinutes: 2520
        },
        hiit: {
            name: 'ğŸƒâ€â™‚ï¸ HIIT', icon: 'fa-running', color: '#f59e0b',
            target: 30, unit: 'minutos', frequency: 5,
            counts: {}, description: '30 minutos de exercÃ­cio intenso, 5 dias por semana',
            totalYear: 0, monthlyTotals: {}
        },
        ppci: {
            name: 'ğŸ› ï¸ PPCI', icon: 'fa-tools', color: '#8b5cf6',
            target: 50, unit: 'minutos', frequency: 3,
            counts: {}, description: '50 minutos de projeto, 3 dias por semana',
            totalYear: 0, monthlyTotals: {}
        },
        dopamine: {
            name: 'ğŸ§  Dopamina', icon: 'fa-brain', color: '#ec4899',
            target: 50, unit: 'minutos', frequency: 2,
            counts: {}, description: '50 minutos de detox, 2 dias por semana',
            totalYear: 0, monthlyTotals: {}
        },
        fasting: {
            name: 'ğŸ¬ Zero AÃ§Ãºcar', icon: 'fa-ban', color: '#06b6d4',
            target: 40, unit: 'dias', frequency: 40,
            currentStreak: 0, completedCycles: 0, lastUpdate: null, lastReset: null,
            counts: {}, description: 'Desafio 40 dias sem aÃ§Ãºcar',
            totalYear: 0, isSpecial: true, monthlyTotals: {}
        }
    }
};

const monthNames = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho',
                    'Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

const comparisonData = {
    reading:  { brAverage: 60,  worldAverage: 210, unit: 'min/sem' },
    english:  { brAverage: 30,  worldAverage: 300, unit: 'min/sem' },
    hiit:     { brAverage: 75,  worldAverage: 150, unit: 'min/sem' },
    ppci:     { brAverage: 60,  worldAverage: 180, unit: 'min/sem' },
    dopamine: { brAverage: 20,  worldAverage: 60,  unit: 'min/sem' }
};

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function getWeekKey(year, week)  { return `${year}-W${String(week).padStart(2,'0')}`; }
function getMonthKey(year, month){ return `${year}-M${String(month).padStart(2,'0')}`; }

function getWeekDates(year, week) {
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const start = new Date(simple);
    if (dow <= 4) start.setDate(simple.getDate() - simple.getDay() + 1);
    else          start.setDate(simple.getDate() + 8 - simple.getDay());
    const end = new Date(start);
    end.setDate(end.getDate() + 6);
    return { start, end };
}

function formatDate(date) { return date.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}); }

function formatTime(minutes, unit) {
    if (unit !== 'minutos') return `${minutes} ${unit}`;
    if (minutes >= 60) {
        const h = Math.floor(minutes/60), m = minutes%60;
        return m > 0 ? `${h}h ${m}min` : `${h}h`;
    }
    return `${minutes} min`;
}

// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            if (parsed.habits) {
                Object.keys(appData.habits).forEach(key => {
                    if (parsed.habits[key]) {
                        appData.habits[key].counts       = parsed.habits[key].counts       || {};
                        appData.habits[key].totalYear    = parsed.habits[key].totalYear    || 0;
                        appData.habits[key].monthlyTotals= parsed.habits[key].monthlyTotals|| {};
                        if (key === 'english') {
                            appData.habits[key].seriesCounts     = parsed.habits[key].seriesCounts     || {};
                            appData.habits[key].carryoverMinutes = parsed.habits[key].carryoverMinutes ?? 2520;
                        }
                        if (key === 'fasting') {
                            appData.habits[key].currentStreak    = parsed.habits[key].currentStreak    || 0;
                            appData.habits[key].completedCycles  = parsed.habits[key].completedCycles  || 0;
                            appData.habits[key].lastUpdate       = parsed.habits[key].lastUpdate       || null;
                            appData.habits[key].lastReset        = parsed.habits[key].lastReset        || null;
                        }
                    }
                });
            }
            if (parsed.currentWeek)  { appData.currentWeek = parsed.currentWeek;   appData.currentYear = parsed.currentYear; }
            if (parsed.currentMonth) { appData.currentMonth = parsed.currentMonth; }
        } catch(e) { console.error('Erro ao carregar:', e); }
    }
    if (!appData.currentWeek)  { const n=new Date(); appData.currentYear=n.getFullYear(); appData.currentWeek=getWeekNumber(n); }
    if (!appData.currentMonth) { appData.currentMonth = new Date().getMonth()+1; }
}

function saveData() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
    catch(e) { console.error('Erro ao salvar:', e); }
}

function updateMonthlyTotals() {
    Object.entries(appData.habits).forEach(([key, habit]) => {
        if (key === 'fasting') return;
        habit.monthlyTotals = {};
        Object.entries(habit.counts).forEach(([weekKey, count]) => {
            const [year, weekStr] = weekKey.split('-W');
            const dates = getWeekDates(parseInt(year), parseInt(weekStr));
            const month = dates.start.getMonth()+1;
            const monthKey = getMonthKey(parseInt(year), month);
            if (!habit.monthlyTotals[monthKey]) habit.monthlyTotals[monthKey] = 0;
            habit.monthlyTotals[monthKey] += count * habit.target;
        });
    });
}

// â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleHabit(habitKey) {
    if (habitKey === 'fasting') return;
    const weekKey = getWeekKey(appData.currentYear, appData.currentWeek);
    const habit   = appData.habits[habitKey];
    if (!habit.counts[weekKey]) habit.counts[weekKey] = 0;
    const maxNormal = habitKey === 'english' ? 5 : habit.frequency;
    if (habit.counts[weekKey] < maxNormal) {
        habit.counts[weekKey]++;
        habit.totalYear += habit.target;
        updateMonthlyTotals(); saveData(); renderAll();
    }
}

function toggleSeries() {
    const weekKey = getWeekKey(appData.currentYear, appData.currentWeek);
    const habit   = appData.habits.english;
    if (!habit.counts[weekKey])      habit.counts[weekKey]      = 0;
    if (!habit.seriesCounts[weekKey])habit.seriesCounts[weekKey]= 0;
    if (habit.counts[weekKey] < 6) {
        habit.counts[weekKey]++;
        habit.seriesCounts[weekKey]++;
        habit.totalYear += habit.target;
        updateMonthlyTotals(); saveData(); renderAll();
    }
}

function decreaseHabit(habitKey) {
    if (habitKey === 'fasting') { resetSugarFree(); return; }
    const weekKey = getWeekKey(appData.currentYear, appData.currentWeek);
    const habit   = appData.habits[habitKey];
    if (habit.counts[weekKey] && habit.counts[weekKey] > 0) {
        if (habitKey === 'english' && habit.seriesCounts?.[weekKey] > 0) habit.seriesCounts[weekKey]--;
        habit.counts[weekKey]--;
        habit.totalYear = Math.max(0, habit.totalYear - habit.target);
        updateMonthlyTotals(); saveData(); renderAll();
    }
}

function startSugarFree() {
    const habit = appData.habits.fasting;
    if (habit.currentStreak > 0) { alert('âš ï¸ VocÃª jÃ¡ tem um desafio em andamento!\n\nSe quiser recomeÃ§ar, use o botÃ£o "Quebrei" primeiro.'); return; }
    if (confirm('ğŸ¯ Iniciar novo desafio de 40 dias sem aÃ§Ãºcar?')) {
        habit.currentStreak = 1;
        habit.lastUpdate = new Date().toISOString().split('T')[0];
        habit.lastReset  = null;
        saveData(); renderAll();
        alert('âœ… Desafio iniciado!\n\nDia 1/40 comeÃ§ou agora. Boa sorte! ğŸ’ª');
    }
}

function resetSugarFree() {
    const habit   = appData.habits.fasting;
    const message = habit.currentStreak > 0
        ? `âš ï¸ VocÃª comeu aÃ§Ãºcar hoje?\n\nIsso vai resetar sua sequÃªncia de ${habit.currentStreak} dias.\n\nTem certeza?`
        : 'Resetar o contador de Zero AÃ§Ãºcar?';
    if (confirm(message)) {
        habit.currentStreak = 0;
        habit.lastUpdate    = null;
        habit.lastReset     = new Date().toISOString().split('T')[0];
        saveData(); renderAll();
    }
}

function updateSugarFreeStreak() {
    const habit = appData.habits.fasting;
    const today = new Date().toISOString().split('T')[0];
    if (habit.lastUpdate === today || habit.currentStreak === 0) return;
    if (habit.lastUpdate) {
        const daysDiff = Math.floor((new Date(today) - new Date(habit.lastUpdate)) / 86400000);
        if (daysDiff === 1) {
            habit.currentStreak++;
            habit.lastUpdate = today;
            if (habit.currentStreak >= 40) {
                habit.completedCycles++;
                habit.totalYear += 40;
                habit.currentStreak = 0;
                habit.lastUpdate    = null;
                habit.lastReset     = null;
            }
            saveData(); renderAll();
        } else if (daysDiff > 1) {
            habit.currentStreak = 0;
            habit.lastUpdate    = null;
            habit.lastReset     = null;
            saveData(); renderAll();
        }
    }
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData() {
    const dados = localStorage.getItem(STORAGE_KEY);
    if (!dados) { alert('Nenhum dado para exportar.'); return; }
    const blob = new Blob([dados], {type: 'application/json'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `habitdb_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// â”€â”€ VIEW SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchView(view) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(view + 'Tab').classList.add('active');
    document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
    document.getElementById(view + 'View').classList.add('active');
    if      (view==='weekly')  renderWeeklyView();
    else if (view==='monthly') renderMonthlyView();
    else if (view==='yearly')  renderYearlyView();
}

function previousWeek() { appData.currentWeek--; if (appData.currentWeek<1){appData.currentWeek=52;appData.currentYear--;} renderWeeklyView(); }
function nextWeek()     { appData.currentWeek++; if (appData.currentWeek>52){appData.currentWeek=1;appData.currentYear++;} renderWeeklyView(); }
function previousMonth(){ appData.currentMonth--; if (appData.currentMonth<1){appData.currentMonth=12;} renderMonthlyView(); }
function nextMonth()    { appData.currentMonth++; if (appData.currentMonth>12){appData.currentMonth=1;} renderMonthlyView(); }

// â”€â”€ RENDER WEEKLY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWeeklyView() { renderStatsOverview(); renderWeekSelector(); renderHabits(); renderWeeklyCharts(); renderRiskAlerts(); generateInsights(); }
function renderMonthlyView(){ renderMonthSelector(); renderMonthStats(); renderMonthChart(); }
function renderYearlyView() { renderYearStats(); renderMonthlyGrid(); renderYearChart(); }

function renderAll() {
    const id = document.querySelector('.view-section.active')?.id || 'weeklyView';
    if      (id==='weeklyView')  renderWeeklyView();
    else if (id==='monthlyView') renderMonthlyView();
    else if (id==='yearlyView')  renderYearlyView();
}

function renderWeekSelector() {
    const dates = getWeekDates(appData.currentYear, appData.currentWeek);
    document.getElementById('weekDisplay').textContent = `Semana ${appData.currentWeek} â€¢ ${formatDate(dates.start)} - ${formatDate(dates.end)}`;
    const now = new Date();
    document.getElementById('nextWeekBtn').disabled = (appData.currentYear===now.getFullYear() && appData.currentWeek===getWeekNumber(now));
}

function renderMonthSelector() {
    document.getElementById('monthDisplay').textContent = `${monthNames[appData.currentMonth-1]} ${appData.currentYear}`;
    const now = new Date();
    document.getElementById('nextMonthBtn').disabled = (appData.currentYear===now.getFullYear() && appData.currentMonth===now.getMonth()+1);
}

function renderStatsOverview() {
    const weekKey   = getWeekKey(appData.currentYear, appData.currentWeek);
    const container = document.getElementById('statsOverview');
    let html = '';
    Object.entries(appData.habits).forEach(([key, habit]) => {
        if (key === 'fasting') {
            const progress  = (habit.currentStreak/40)*100;
            const today     = new Date().toISOString().split('T')[0];
            const isActive  = habit.lastUpdate === today;
            const isWaiting = habit.currentStreak === 0;
            let statusText  = isWaiting ? 'â¸ï¸ Parado' : isActive ? 'ğŸŸ¢ Ativo Hoje' : 'âšª Aguardando';
            let completionInfo = '';
            if (habit.currentStreak > 0 && habit.currentStreak < 40) {
                const d = new Date(); d.setDate(d.getDate()+(40-habit.currentStreak));
                completionInfo = `Termina: ${d.getDate()} ${d.toLocaleDateString('pt-BR',{month:'short'})}`;
            }
            html += `<div class="stat-card ${key}">
                <div class="stat-icon"><i class="fas ${habit.icon}"></i></div>
                <div class="stat-label">${habit.name}</div>
                <div class="stat-value">${habit.currentStreak}/40</div>
                <div class="stat-meta">${statusText}</div>
                ${completionInfo ? `<div style="margin-top:8px;font-size:.85rem;color:${habit.color};font-weight:600;">ğŸ“… ${completionInfo}</div>` : ''}
                <div style="margin-top:10px;font-size:.85rem;color:${progress>=100?'var(--secondary)':progress>=50?'var(--warning)':'var(--gray)'}">
                    ${habit.completedCycles} desafios completos
                </div>
            </div>`;
        } else {
            const count      = habit.counts[weekKey]||0;
            const total      = count * habit.target;
            const completion = Math.min((count/habit.frequency)*100, 100);
            html += `<div class="stat-card ${key}">
                <div class="stat-icon"><i class="fas ${habit.icon}"></i></div>
                <div class="stat-label">${habit.name}</div>
                <div class="stat-value">${count}/${habit.frequency}</div>
                <div class="stat-meta">${formatTime(total, habit.unit)} esta semana</div>
                <div style="margin-top:10px;font-size:.85rem;color:${completion>=100?'var(--secondary)':completion>=60?'var(--warning)':'var(--gray)'}">
                    ${completion.toFixed(0)}% completo
                </div>
            </div>`;
        }
    });
    container.innerHTML = html;
}

function renderHabits() {
    const weekKey   = getWeekKey(appData.currentYear, appData.currentWeek);
    const container = document.getElementById('habitsGrid');
    let html = '';
    Object.entries(appData.habits).forEach(([key, habit]) => {
        if (key === 'fasting') {
            const progress  = (habit.currentStreak/40)*100;
            const remaining = Math.max(0, 40-habit.currentStreak);
            const today     = new Date().toISOString().split('T')[0];
            const isActive  = habit.lastUpdate === today;
            const isWaiting = habit.currentStreak === 0;
            let statusMsg   = isWaiting ? 'â¸ï¸ Parado. Clique em "Iniciar Desafio" para comeÃ§ar!' : isActive ? 'âœ… Atualizado hoje!' : 'â° SerÃ¡ atualizado automaticamente Ã s 00:00';
            let statusBg    = isActive ? 'rgba(16,185,129,0.1)' : 'rgba(148,163,184,0.1)';
            let statusBorder= isActive ? 'var(--secondary)' : 'var(--gray)';
            html += `<div class="habit-card ${key}">
                <div class="habit-header">
                    <div class="habit-title">
                        <div class="habit-icon"><i class="fas ${habit.icon}"></i></div>
                        <div>
                            <div class="habit-name">${habit.name}</div>
                            <div style="font-size:.85rem;color:var(--gray);">âš™ï¸ Contador AutomÃ¡tico</div>
                        </div>
                    </div>
                    <div class="habit-count">${habit.currentStreak}</div>
                </div>
                <div class="habit-description">${habit.description}</div>
                <div style="background:${statusBg};padding:14px;border-radius:8px;margin:15px 0;border-left:3px solid ${statusBorder};">
                    <div style="font-size:.95rem;font-weight:600;color:${isActive?'var(--secondary)':'var(--gray)'};">${statusMsg}</div>
                </div>
                <div class="habit-progress">
                    <div class="progress-label">
                        <span style="color:var(--gray)">Progresso</span>
                        <span style="color:${habit.color};font-weight:700">${progress.toFixed(0)}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                </div>
                <div class="habit-stats">
                    <div class="stat-item"><div class="stat-item-label">Dias</div><div class="stat-item-value">${habit.currentStreak}</div></div>
                    <div class="stat-item"><div class="stat-item-label">Faltam</div><div class="stat-item-value">${remaining}d</div></div>
                    <div class="stat-item"><div class="stat-item-label">Completos 2026</div><div class="stat-item-value">${habit.completedCycles}</div></div>
                    <div class="stat-item"><div class="stat-item-label">Status</div><div class="stat-item-value">${progress>=100?'ğŸ†':habit.currentStreak>0?'ğŸ”¥':'âšª'}</div></div>
                </div>
                <div style="margin-top:20px;">
                    ${habit.currentStreak===0
                        ? `<button class="habit-btn btn-add" onclick="startSugarFree()" style="width:100%;"><i class="fas fa-play"></i> Iniciar Desafio Agora</button>`
                        : `<button class="habit-btn btn-remove" onclick="resetSugarFree()" style="width:100%;"><i class="fas fa-times"></i> Quebrei! Comi AÃ§Ãºcar Hoje</button>`
                    }
                </div>
            </div>`;
        } else {
            const count      = habit.counts[weekKey]||0;
            const total      = count * habit.target;
            const seriesCount= key==='english' ? (habit.seriesCounts?.[weekKey]||0) : 0;
            const sessions   = count;
            const completion = Math.min((sessions/habit.frequency)*100, 100);
            const cmp        = comparisonData[key];
            let vsBR='', vsWorld='', statusLevel='', statusColor='';
            if (cmp) {
                const pBR    = Math.round((total/cmp.brAverage)*100);
                const pWorld = Math.round((total/cmp.worldAverage)*100);
                vsBR    = total>=cmp.brAverage*2 ? `ğŸ‡§ğŸ‡· ${Math.floor(total/cmp.brAverage)}x mÃ©dia BR` : total>=cmp.brAverage ? `ğŸ‡§ğŸ‡· Acima da mÃ©dia` : total>0 ? `ğŸ‡§ğŸ‡· ${pBR}% da mÃ©dia` : `ğŸ‡§ğŸ‡· Comece hoje!`;
                vsWorld = total>=cmp.worldAverage ? `ğŸŒ NÃ­vel mundial!` : total>0 ? `ğŸŒ ${pWorld}% da meta` : `ğŸŒ Meta: ${cmp.worldAverage}min`;
                if      (total>=cmp.worldAverage*1.5) { statusLevel='ğŸ‘‘ Elite Global'; statusColor='#8b5cf6'; }
                else if (total>=cmp.worldAverage)     { statusLevel='ğŸ† Mundial';      statusColor='#10b981'; }
                else if (total>=cmp.brAverage)        { statusLevel='âš¡ Acima BR';     statusColor='#f59e0b'; }
                else if (total>0)                     { statusLevel='ğŸ¯ Progredindo';  statusColor='#06b6d4'; }
                else                                  { statusLevel='â–¶ï¸ Iniciar';      statusColor='#6b7280'; }
            }
            const rotatingBadges = JSON.stringify([
                {label:vsBR,    color:total>=cmp.brAverage?'#10b981':'#ef4444'},
                {label:vsWorld, color:total>=cmp.worldAverage?'#10b981':'#f59e0b'},
                {label:statusLevel, color:statusColor}
            ]);

            // CEFR for English
            let cefrBlock = '';
            if (key === 'english') {
                const totalMin   = (habit.totalYear||0)+(habit.carryoverMinutes||0);
                const totalHours = Math.round((totalMin/60)*100)/100;
                const levels     = [{level:'A1',min:0,max:100,label:'Iniciante'},{level:'A2',min:100,max:250,label:'BÃ¡sico'},{level:'B1',min:250,max:500,label:'IntermediÃ¡rio'},{level:'B2',min:500,max:800,label:'Int. Alto'},{level:'C1',min:800,max:1200,label:'AvanÃ§ado'},{level:'C2',min:1200,max:1200,label:'Maestria'}];
                const idx        = levels.findIndex(l=>totalHours<l.max||l.level==='C2');
                const lvl        = levels[Math.max(0,idx)];
                const nextLvl    = levels[Math.min(idx+1,levels.length-1)];
                const hoursIn    = totalHours-lvl.min;
                const range      = lvl.max-lvl.min;
                const pct        = lvl.level==='C2'?100:Math.min(Math.round((hoursIn/range)*100),100);
                const hoursLeft  = lvl.level==='C2'?0:Math.max(0,Math.round((lvl.max-totalHours)*10)/10);
                const lColors    = {A1:'#94a3b8',A2:'#06b6d4',B1:'#10b981',B2:'#f59e0b',C1:'#8b5cf6',C2:'#ef4444'};
                const clr        = lColors[lvl.level];
                cefrBlock = `<div style="margin-top:15px;padding:15px;background:rgba(15,23,42,0.5);border-radius:10px;border:1px solid rgba(255,255,255,0.08);">
                    <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                        <div style="font-size:.75rem;font-weight:700;color:var(--gray);text-transform:uppercase;"><i class="fas fa-graduation-cap"></i> NÃ­vel CEFR</div>
                        <div style="font-size:.75rem;color:var(--gray);">${totalHours}h acumuladas</div>
                    </div>
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:1.6rem;font-weight:900;color:${clr};">${lvl.level}</span>
                            <div>
                                <div style="font-size:.85rem;font-weight:600;color:var(--light);">${lvl.label}</div>
                                <div style="font-size:.72rem;color:var(--gray);">${lvl.min}h â€“ ${lvl.level==='C2'?'âˆ':lvl.max+'h'}</div>
                            </div>
                        </div>
                        ${lvl.level!=='C2'?`<div style="text-align:right;">
                            <div style="font-size:.72rem;color:var(--gray);">PrÃ³ximo</div>
                            <div style="font-size:1rem;font-weight:800;color:${lColors[nextLvl.level]};">${nextLvl.level}</div>
                            <div style="font-size:.72rem;color:var(--gray);">${hoursLeft}h</div>
                        </div>`:'<div style="font-size:.85rem;color:#ef4444;font-weight:700;">ğŸ† Maestria</div>'}
                    </div>
                    <div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-size:.72rem;color:var(--gray);">Progresso em ${lvl.level}</span>
                            <span style="font-size:.72rem;font-weight:700;color:${clr};">${pct}%</span>
                        </div>
                        <div style="height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;">
                            <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,${clr},${clr}99);border-radius:3px;transition:width .5s;"></div>
                        </div>
                    </div>
                    <div style="display:flex;gap:3px;margin-top:10px;">
                        ${levels.map(l=>`<div style="flex:1;text-align:center;">
                            <div style="height:3px;border-radius:2px;background:${totalHours>=l.min?lColors[l.level]:'rgba(255,255,255,0.1)'};margin-bottom:3px;"></div>
                            <div style="font-size:.62rem;color:${l.level===lvl.level?lColors[l.level]:'rgba(255,255,255,0.25)'};font-weight:${l.level===lvl.level?'800':'400'};">${l.level}</div>
                        </div>`).join('')}
                    </div>
                </div>`;
            }

            html += `<div class="habit-card ${key}">
                <div class="habit-header">
                    <div class="habit-title">
                        <div class="habit-icon"><i class="fas ${habit.icon}"></i></div>
                        <div>
                            <div class="habit-name">${habit.name}</div>
                            <div style="font-size:.85rem;color:var(--gray);">Meta: ${habit.frequency}x/semana</div>
                        </div>
                    </div>
                    <div class="habit-count">${sessions}x</div>
                </div>
                <div class="habit-description">${habit.description}</div>
                <div class="habit-progress">
                    <div class="progress-label">
                        <span style="color:var(--gray)">Progresso Semanal</span>
                        <span style="color:${habit.color};font-weight:700">${completion.toFixed(0)}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${completion}%"></div></div>
                </div>
                <div class="habit-stats">
                    <div class="stat-item"><div class="stat-item-label">Esta Semana</div><div class="stat-item-value">${formatTime(total,habit.unit)}</div></div>
                    <div class="stat-item"><div class="stat-item-label">Total 2026</div><div class="stat-item-value">${formatTime(habit.totalYear,habit.unit)}</div></div>
                    <div class="stat-item rotating-comparison" data-badges='${rotatingBadges}' data-current="0">
                        <div class="stat-item-label">ComparaÃ§Ã£o <i class="fas fa-sync-alt" style="font-size:.7rem;opacity:.5;"></i></div>
                        <div class="stat-item-value comparison-badge" style="font-size:.9rem;color:${total>=(cmp?.brAverage||0)?'#10b981':'#ef4444'};">${vsBR}</div>
                    </div>
                    <div class="stat-item"><div class="stat-item-label">Status</div><div class="stat-item-value">${completion>=100?'âœ… Meta':completion>=60?'âš¡ Ã“timo':'â³ Continue'}</div></div>
                </div>
                ${key==='english' ? `
                    <div class="habit-controls">
                        <button class="habit-btn btn-add" onclick="toggleHabit('english')"><i class="fas fa-plus"></i> 50 min Estudo</button>
                        <button class="habit-btn btn-add" onclick="toggleSeries()" style="background:linear-gradient(135deg,#06b6d4,#0891b2);"><i class="fas fa-tv"></i> SÃ©rie (50min)</button>
                    </div>
                    <div style="margin-top:8px;"><button class="habit-btn btn-remove" onclick="decreaseHabit('english')" style="width:100%;"><i class="fas fa-minus"></i> Remover</button></div>
                ` : `
                    <div class="habit-controls">
                        <button class="habit-btn btn-add" onclick="toggleHabit('${key}')"><i class="fas fa-plus"></i> +${habit.target}min</button>
                        <button class="habit-btn btn-remove" onclick="decreaseHabit('${key}')"><i class="fas fa-minus"></i> Remover</button>
                    </div>
                `}
                ${cefrBlock}
            </div>`;
        }
    });
    container.innerHTML = html;
}

// â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWeeklyCharts() {
    const weekKey = getWeekKey(appData.currentYear, appData.currentWeek);
    const labels=[], data=[], colors=[];
    Object.entries(appData.habits).forEach(([key,habit]) => {
        labels.push(habit.name);
        if (key==='fasting') data.push(Math.min((habit.currentStreak/40)*100,100));
        else { const c=habit.counts[weekKey]||0; data.push(Math.min((c/habit.frequency)*100,100)); }
        colors.push(habit.color);
    });
    destroyChart('allHabitsChart');
    window.allHabitsChart = new Chart(document.getElementById('allHabitsChart'), {
        type:'bar', data:{labels, datasets:[{label:'Progresso (%)',data,backgroundColor:colors.map(c=>c+'80'),borderColor:colors,borderWidth:2,borderRadius:8}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(15,23,42,.9)',callbacks:{label:c=>`${c.parsed.y.toFixed(0)}% da meta`}}},scales:{y:{beginAtZero:true,max:100,ticks:{color:'#f8fafc',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.1)'}},x:{ticks:{color:'#f8fafc'},grid:{color:'rgba(255,255,255,.1)'}}}}
    });

    const weeks=[]; const datasets=[];
    for (let i=7;i>=0;i--) {
        let wn=appData.currentWeek-i, yn=appData.currentYear;
        if (wn<1){wn=52+wn;yn--;}
        weeks.push(`Sem ${wn}`);
    }
    Object.entries(appData.habits).forEach(([key,habit]) => {
        const d=[];
        for (let i=7;i>=0;i--) {
            let wn=appData.currentWeek-i, yn=appData.currentYear;
            if (wn<1){wn=52+wn;yn--;}
            const wk=getWeekKey(yn,wn), c=habit.counts[wk]||0;
            d.push(Math.min((c/habit.frequency)*100,100));
        }
        datasets.push({label:habit.name,data:d,borderColor:habit.color,backgroundColor:habit.color+'20',borderWidth:3,tension:0.4,fill:true});
    });
    destroyChart('evolutionChart');
    window.evolutionChart = new Chart(document.getElementById('evolutionChart'), {
        type:'line', data:{labels:weeks,datasets},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#f8fafc',font:{size:12}}},tooltip:{backgroundColor:'rgba(15,23,42,.9)'}},scales:{y:{beginAtZero:true,max:100,ticks:{color:'#f8fafc',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.1)'}},x:{ticks:{color:'#f8fafc'},grid:{color:'rgba(255,255,255,.1)'}}}}
    });
}

function renderMonthStats() {
    const monthKey  = getMonthKey(appData.currentYear, appData.currentMonth);
    const container = document.getElementById('monthStatsOverview');
    let html = '';
    Object.entries(appData.habits).forEach(([key,habit]) => {
        if (key==='fasting') return;
        const total = habit.monthlyTotals[monthKey]||0;
        html += `<div class="stat-card ${key}"><div class="stat-icon"><i class="fas ${habit.icon}"></i></div><div class="stat-label">${habit.name}</div><div class="stat-value">${total}</div><div class="stat-meta">${habit.unit} em ${monthNames[appData.currentMonth-1]}</div></div>`;
    });
    container.innerHTML = html;
}

function renderMonthChart() {
    const monthKey = getMonthKey(appData.currentYear, appData.currentMonth);
    const labels=[], data=[], colors=[];
    Object.entries(appData.habits).forEach(([key,habit]) => { if(key==='fasting')return; labels.push(habit.name); data.push(habit.monthlyTotals[monthKey]||0); colors.push(habit.color); });
    destroyChart('monthChart');
    window.monthChart = new Chart(document.getElementById('monthChart'), {
        type:'bar', data:{labels,datasets:[{label:'Total do MÃªs',data,backgroundColor:colors.map(c=>c+'80'),borderColor:colors,borderWidth:2,borderRadius:8}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{color:'#f8fafc'},grid:{color:'rgba(255,255,255,.1)'}},x:{ticks:{color:'#f8fafc'},grid:{color:'rgba(255,255,255,.1)'}}}}
    });
}

function renderYearStats() {
    const container = document.getElementById('yearStatsOverview');
    let html = '';
    Object.entries(appData.habits).forEach(([key,habit]) => {
        if (key==='fasting') {
            html += `<div class="stat-card ${key}"><div class="stat-icon"><i class="fas ${habit.icon}"></i></div><div class="stat-label">${habit.name}</div><div class="stat-value">${habit.completedCycles}</div><div class="stat-meta">Desafios completos</div><div style="margin-top:10px;font-size:.85rem;color:var(--gray)">${habit.completedCycles*40} dias total</div></div>`;
        } else {
            html += `<div class="stat-card ${key}"><div class="stat-icon"><i class="fas ${habit.icon}"></i></div><div class="stat-label">${habit.name}</div><div class="stat-value">${formatTime(habit.totalYear,habit.unit)}</div><div class="stat-meta">acumulados em 2026</div></div>`;
        }
    });
    container.innerHTML = html;
}

function renderMonthlyGrid() {
    const container = document.getElementById('monthlyGrid');
    let html = '';
    for (let m=1;m<=12;m++) {
        const mk = getMonthKey(2026, m);
        html += `<div class="month-card"><div class="month-name"><i class="fas fa-calendar"></i>${monthNames[m-1]}</div><div class="month-stats">`;
        Object.entries(appData.habits).forEach(([key,habit]) => {
            if (key==='fasting') return;
            const t = habit.monthlyTotals[mk]||0;
            html += `<div class="month-stat-item"><span style="color:var(--gray);font-size:.85rem;">${habit.name}</span><span style="color:${habit.color};font-weight:700;">${formatTime(t,habit.unit)}</span></div>`;
        });
        html += `</div></div>`;
    }
    container.innerHTML = html;
}

function renderYearChart() {
    const datasets = [];
    Object.entries(appData.habits).forEach(([key,habit]) => {
        if (key==='fasting') return;
        const data = [];
        for (let m=1;m<=12;m++) data.push(habit.monthlyTotals[getMonthKey(2026,m)]||0);
        datasets.push({label:habit.name,data,borderColor:habit.color,backgroundColor:habit.color+'20',borderWidth:3,tension:0.4,fill:true});
    });
    destroyChart('yearChart');
    window.yearChart = new Chart(document.getElementById('yearChart'), {
        type:'line', data:{labels:monthNames,datasets},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#f8fafc',font:{size:12}}}},scales:{y:{beginAtZero:true,ticks:{color:'#f8fafc'},grid:{color:'rgba(255,255,255,.1)'}},x:{ticks:{color:'#f8fafc'},grid:{color:'rgba(255,255,255,.1)'}}}}
    });
}

function destroyChart(id) {
    const key = id; if (window[key]?.destroy) { window[key].destroy(); }
}

// â”€â”€ RISK DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectRisks() {
    const risks = [];
    Object.entries(appData.habits).forEach(([key,habit]) => {
        if (key==='fasting') return;
        const weekData = [];
        for (let i=0;i<3;i++) {
            let wn=appData.currentWeek-i, yn=appData.currentYear;
            if (wn<1){wn=52+wn;yn--;}
            const c=habit.counts[getWeekKey(yn,wn)]||0;
            weekData.push({count:c, percentage:(c/habit.frequency)*100});
        }
        if (weekData[0].count===0 && weekData[1].count===0) {
            risks.push({key,habitName:habit.name,habitIcon:habit.icon,habitColor:habit.color,level:'critical',icon:'ğŸš¨',title:`${habit.name}: Abandono Iminente`,message:`VocÃª estÃ¡ hÃ¡ 2 semanas sem registrar ${habit.name}.`,suggestion:getSuggestion(key,'critical')});
        } else if (weekData[0].percentage<40 && weekData[1].percentage<40 && weekData[2].percentage<40) {
            risks.push({key,habitName:habit.name,habitIcon:habit.icon,habitColor:habit.color,level:'high',icon:'âš ï¸',title:`${habit.name}: Risco Alto`,message:`3 semanas consecutivas abaixo de 40% da meta.`,suggestion:getSuggestion(key,'high')});
        } else if (weekData[0].percentage<50 && weekData[1].percentage<50) {
            risks.push({key,habitName:habit.name,habitIcon:habit.icon,habitColor:habit.color,level:'medium',icon:'âš ï¸',title:`${habit.name}: Risco MÃ©dio`,message:`2 semanas seguidas abaixo de 50% da meta.`,suggestion:getSuggestion(key,'medium')});
        }
    });
    return risks;
}

function getSuggestion(habitKey, riskLevel) {
    const s = {
        reading:  {critical:'Comece com 10min antes de dormir hoje.',high:'Reduza para 15min/dia, 3x/semana.',medium:'Leia durante o cafÃ© da manhÃ£.'},
        english:  {critical:'Assista 1 episÃ³dio em inglÃªs (legendas PT) hoje.',high:'Reduza para 25min/dia, 3x/semana.',medium:'Combine estudo com sÃ©rie: 30min + 20min.'},
        hiit:     {critical:'FaÃ§a 10min de caminhada agora.',high:'Reduza para 15min, 3x/semana.',medium:'Treine de manhÃ£ antes de tomar decisÃµes.'},
        ppci:     {critical:'Dedique 20min para planejar um mini-projeto.',high:'Reduza para 30min, 2x/semana.',medium:'Bloqueie horÃ¡rios fixos na agenda.'},
        dopamine: {critical:'Desative notificaÃ§Ãµes por 1h agora.',high:'Tente 20min/dia de detox.',medium:'Substitua redes por leitura de 10min.'}
    };
    return s[habitKey]?.[riskLevel] || 'Retome hoje mesmo! Pequenos passos = grandes mudanÃ§as.';
}

function renderRiskAlerts() {
    const risks     = detectRisks();
    const container = document.getElementById('riskAlertsSection');
    if (!risks.length) { container.innerHTML=''; return; }
    let html = `<div style="margin-bottom:30px;"><div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;"><i class="fas fa-exclamation-triangle" style="color:#ef4444;font-size:1.8rem;"></i><h2 style="font-size:1.5rem;color:var(--light);">Alertas de Risco</h2></div><div style="display:grid;gap:15px;">`;
    risks.forEach(r => {
        const bc = r.level==='critical'?'#ef4444':'#f59e0b';
        const bg = r.level==='critical'?'rgba(239,68,68,.1)':'rgba(245,158,11,.08)';
        const ac = r.level==='critical'?'risk-alert risk-alert-critical':'risk-alert';
        html += `<div class="${ac}" style="background:${bg};border-left:4px solid ${bc};padding:20px;border-radius:12px;">
            <div style="display:flex;gap:15px;align-items:flex-start;">
                <div style="width:50px;height:50px;background:rgba(15,23,42,.4);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i class="fas ${r.habitIcon}" style="font-size:1.5rem;color:${r.habitColor};"></i>
                </div>
                <div style="flex:1;">
                    <h3 style="font-size:1.1rem;color:var(--light);margin-bottom:10px;">${r.icon} ${r.title}</h3>
                    <p style="color:var(--gray);margin-bottom:12px;">${r.message}</p>
                    <div style="background:rgba(16,185,129,.1);border-left:3px solid var(--secondary);padding:12px 15px;border-radius:6px;">
                        <i class="fas fa-lightbulb" style="color:var(--secondary);"></i>
                        <strong style="color:var(--secondary);font-size:.8rem;"> SUGESTÃƒO</strong>
                        <div style="color:var(--light);font-size:.9rem;margin-top:4px;">${r.suggestion}</div>
                    </div>
                </div>
            </div>
        </div>`;
    });
    html += `</div></div>`;
    container.innerHTML = html;
}

function generateInsights() {
    const weekKey   = getWeekKey(appData.currentYear, appData.currentWeek);
    const container = document.getElementById('insightsSection');
    const insights  = [];
    Object.entries(appData.habits).forEach(([key,habit]) => {
        if (key==='fasting') {
            if (habit.completedCycles>0) insights.push({type:'success',icon:'fa-trophy',title:`ğŸ† ${habit.name}: ${habit.completedCycles} Desafio(s) Completo(s)!`,text:`${habit.completedCycles*40} dias livres de aÃ§Ãºcar em 2026!`});
            if (habit.currentStreak>=30) insights.push({type:'warning',icon:'fa-fire',title:`ğŸ”¥ Reta Final!`,text:`${habit.currentStreak} dias consecutivos! Faltam ${40-habit.currentStreak} para concluir.`});
        } else {
            const c=habit.counts[weekKey]||0, completion=Math.min((c/habit.frequency)*100,100);
            if (completion>=100) insights.push({type:'success',icon:'fa-trophy',title:`ğŸ† ${habit.name}: META COMPLETA!`,text:`VocÃª atingiu ${c}/${habit.frequency} dias esta semana!`});
        }
    });
    if (!insights.length) insights.push({type:'info',icon:'fa-info-circle',title:'Comece Sua Jornada',text:'Registre seus primeiros hÃ¡bitos e acompanhe seu progresso ao longo de 2026!'});
    container.innerHTML = insights.slice(0,6).map(i=>`
        <div class="insight-card ${i.type}">
            <div class="insight-icon"><i class="fas ${i.icon}"></i></div>
            <div class="insight-content"><h3>${i.title}</h3><p>${i.text}</p></div>
        </div>`).join('');
}

// â”€â”€ COMPARISON ROTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startComparisonRotation() {
    setInterval(() => {
        document.querySelectorAll('.rotating-comparison').forEach(el => {
            try {
                const badges  = JSON.parse(el.getAttribute('data-badges'));
                const current = parseInt(el.getAttribute('data-current')||'0');
                const badge   = el.querySelector('.comparison-badge');
                if (!badge||!badges.length) return;
                badge.classList.add('fade-out');
                setTimeout(() => {
                    const next = (current+1) % badges.length;
                    badge.textContent  = badges[next].label;
                    badge.style.color  = badges[next].color;
                    el.setAttribute('data-current', next);
                    badge.classList.remove('fade-out');
                }, 400);
            } catch(e) {}
        });
    }, 3000);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp() {
    loadData();
    updateMonthlyTotals();
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    updateSugarFreeStreak();
    renderAll();
    startComparisonRotation();
    setInterval(updateSugarFreeStreak, 60000);
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
